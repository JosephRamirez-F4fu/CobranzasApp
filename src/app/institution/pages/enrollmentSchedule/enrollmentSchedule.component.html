<section class="workspace-stack">
  <app-institution-enrollment-schedule-form
    [form]="form"
    [saving]="saving()"
    [editing]="editing()"
    (submitted)="onSubmit()"
    (canceled)="onCancelEdit()"
    (cleared)="onClearForm()"
  ></app-institution-enrollment-schedule-form>

  <div *ngIf="feedback() as message" class="workspace-message workspace-message--success">
    {{ message }}
  </div>

  <form [formGroup]="filtersForm" (ngSubmit)="onApplyFilters()" class="workspace-filters">
    <div class="workspace-filter-field">
      <label class="workspace-filter-label" for="filter-year">Año lectivo</label>
      <input
        id="filter-year"
        type="number"
        formControlName="anioLectivo"
        placeholder="Ej. 2024"
        min="2000"
        class="workspace-input workspace-input--compact"
      />
    </div>

    <div class="workspace-filter-field">
      <label class="workspace-filter-label" for="filter-level">Nivel educativo</label>
      <select
        id="filter-level"
        formControlName="nivelEducativo"
        class="workspace-input workspace-input--compact"
      >
        <option value="">Todos</option>
        <option *ngFor="let level of levels" [value]="level">{{ level | titlecase }}</option>
      </select>
    </div>

    <div class="workspace-filter-field">
      <label class="workspace-filter-label" for="filter-status">Estado</label>
      <select
        id="filter-status"
        formControlName="activo"
        class="workspace-input workspace-input--compact"
      >
        <option value="">Todos</option>
        <option value="true">Activos</option>
        <option value="false">Inactivos</option>
      </select>
    </div>

    <div class="workspace-filter-actions">
      <button type="submit" class="workspace-primary-btn workspace-btn-compact">
        Aplicar filtros
      </button>
      <button
        type="button"
        (click)="onResetFilters()"
        class="workspace-secondary-btn workspace-btn-compact"
      >
        Limpiar filtros
      </button>
    </div>
  </form>

  <app-institution-enrollment-schedule-table
    [schedules]="schedules()"
    [loading]="loading()"
    [page]="page()"
    [totalPages]="totalPages()"
    [totalItems]="totalItems()"
    (edit)="onEdit($event)"
    (remove)="onDelete($event)"
    (editQuota)="onEditQuota($event)"
    (pageChange)="onPageChange($event)"
  ></app-institution-enrollment-schedule-table>

  <form
    *ngIf="selectedQuotaSchedule() as schedule"
    [formGroup]="quotaForm"
    (ngSubmit)="onSubmitQuota()"
    class="workspace-card workspace-form"
  >
    <header class="workspace-form-header">
      <h3 class="workspace-heading-md">
        Editar cuota del cronograma {{ schedule.anioLectivo }} - {{ schedule.nivelEducativo | titlecase }}
      </h3>
      <p class="workspace-subheading">
        Actualiza el monto y la fecha de vencimiento de la cuota seleccionada.
      </p>
    </header>

    <div class="workspace-fieldset">
      <label class="workspace-field">
        <span class="workspace-label">Monto (S/)</span>
        <input
          type="number"
          formControlName="monto"
          placeholder="Ej. 350"
          min="0"
          step="0.01"
          class="workspace-input workspace-input--compact"
          [ngClass]="{
            'workspace-input-error':
              quotaForm.controls['monto'].invalid && quotaForm.controls['monto'].touched
          }"
        />
        <small
          *ngIf="quotaForm.controls['monto'].invalid && quotaForm.controls['monto'].touched"
          class="workspace-error"
        >
          Ingrese un monto válido.
        </small>
      </label>

      <label class="workspace-field">
        <span class="workspace-label">Fecha de vencimiento</span>
        <input
          type="date"
          formControlName="fechaVencimiento"
          class="workspace-input workspace-input--compact"
          [ngClass]="{
            'workspace-input-error':
              quotaForm.controls['fechaVencimiento'].invalid && quotaForm.controls['fechaVencimiento'].touched
          }"
        />
        <small
          *ngIf="quotaForm.controls['fechaVencimiento'].invalid && quotaForm.controls['fechaVencimiento'].touched"
          class="workspace-error"
        >
          Seleccione una fecha de vencimiento.
        </small>
      </label>
    </div>

    <footer class="workspace-form-actions">
      <button
        type="submit"
        [disabled]="quotaForm.invalid || quotaSaving()"
        class="workspace-primary-btn"
      >
        {{ quotaSaving() ? 'Actualizando…' : 'Actualizar cuota' }}
      </button>
      <button
        type="button"
        (click)="onCancelQuotaEdit()"
        [disabled]="quotaSaving()"
        class="workspace-secondary-btn"
      >
        Cancelar
      </button>
    </footer>
  </form>
</section>
