<section class="mx-auto grid max-w-6xl gap-6">
  <header class="space-y-2">
    <p class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Alumnos</p>
    <h1 class="text-3xl font-bold text-slate-900">Estado de cuenta</h1>
    <p class="text-sm text-slate-500">
      Selecciona un alumno desde el listado de alumnos para consultar su estado de cuenta consolidado.
    </p>
    <a
      routerLink="/institution/alumnos"
      class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 transition hover:-translate-y-0.5 hover:text-indigo-500"
    >
      ← Volver al listado de alumnos
    </a>
  </header>

  <div *ngIf="error() as errorMessage" class="rounded-xl bg-rose-50 px-4 py-3 text-sm font-semibold text-rose-700 shadow-lg shadow-rose-300/30">
    {{ errorMessage }}
  </div>

  <div *ngIf="loading()" class="rounded-xl border border-dashed border-slate-200 bg-white px-4 py-6 text-center text-sm text-slate-500">
    Cargando información del alumno…
  </div>

  <ng-container *ngIf="!loading()">
    <ng-container *ngIf="status() as account; else selectStudent">
      <section class="grid gap-4 rounded-2xl bg-white p-6 shadow-xl shadow-slate-900/10">
        <header class="flex flex-col gap-1">
          <h2 class="text-2xl font-semibold text-slate-900">{{ account.nombreCompleto }}</h2>
          <p class="text-sm text-slate-500">Identificador: {{ account.id }}</p>
        </header>

        <div class="grid gap-4 md:grid-cols-3">
          <div class="rounded-xl bg-indigo-50 p-4 text-indigo-700 shadow-inner">
            <p class="text-xs font-semibold uppercase tracking-wide">Total pagado</p>
            <p class="text-2xl font-bold">{{ account.totalPagado | currency:'PEN':'symbol':'1.2-2' }}</p>
          </div>
          <div class="rounded-xl bg-amber-50 p-4 text-amber-700 shadow-inner">
            <p class="text-xs font-semibold uppercase tracking-wide">Pendiente</p>
            <p class="text-2xl font-bold">{{ account.totalPendiente | currency:'PEN':'symbol':'1.2-2' }}</p>
          </div>
          <div class="rounded-xl bg-rose-50 p-4 text-rose-700 shadow-inner">
            <p class="text-xs font-semibold uppercase tracking-wide">Morosidad</p>
            <p class="text-2xl font-bold">{{ account.morosidad | currency:'PEN':'symbol':'1.2-2' }}</p>
          </div>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-slate-900">Matrículas y cuotas</h3>
          <div *ngIf="account.matriculas.length; else noEnrollments" class="grid gap-4">
            <article
              *ngFor="let enrollment of account.matriculas"
              class="rounded-2xl border border-slate-200 bg-slate-50 p-5 shadow-sm"
            >
              <header class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold text-indigo-600">{{ enrollment.periodoAcademico || 'Periodo sin definir' }}</p>
                  <h4 class="text-xl font-bold text-slate-900">Matrícula #{{ enrollment.id }}</h4>
                </div>
                <span
                  class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold"
                  [ngClass]="{
                    'bg-emerald-100 text-emerald-700': enrollment.estado === 'PAGADO',
                    'bg-amber-100 text-amber-700': enrollment.estado === 'PENDIENTE',
                    'bg-rose-100 text-rose-700': enrollment.estado === 'VENCIDO' || enrollment.estado === 'ANULADO'
                  }"
                >
                  {{ enrollment.estado || 'PENDIENTE' }}
                </span>
              </header>

              <dl class="mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2 md:grid-cols-4">
                <div>
                  <dt class="text-xs font-semibold uppercase tracking-wide">Monto total</dt>
                  <dd class="font-semibold text-slate-900">{{ enrollment.montoTotal | currency:'PEN':'symbol':'1.2-2' }}</dd>
                </div>
                <div>
                  <dt class="text-xs font-semibold uppercase tracking-wide">Pagado</dt>
                  <dd class="font-semibold text-emerald-700">{{ enrollment.totalPagado | currency:'PEN':'symbol':'1.2-2' }}</dd>
                </div>
                <div>
                  <dt class="text-xs font-semibold uppercase tracking-wide">Saldo pendiente</dt>
                  <dd class="font-semibold text-amber-700">{{ enrollment.saldoPendiente | currency:'PEN':'symbol':'1.2-2' }}</dd>
                </div>
                <div>
                  <dt class="text-xs font-semibold uppercase tracking-wide">Morosidad</dt>
                  <dd class="font-semibold text-rose-700">{{ enrollment.morosidad | currency:'PEN':'symbol':'1.2-2' }}</dd>
                </div>
              </dl>

              <div *ngIf="enrollment.pagos.length; else noPayments" class="mt-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                  <thead class="bg-white">
                    <tr>
                      <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Fecha</th>
                      <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Monto</th>
                      <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Método</th>
                      <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Operación</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200 bg-white text-slate-700">
                    <tr *ngFor="let payment of enrollment.pagos" class="transition hover:bg-slate-50">
                      <td class="px-4 py-2">{{ payment.fechaPago | date:'mediumDate' }}</td>
                      <td class="px-4 py-2 font-semibold text-emerald-700">{{ payment.montoPagado | currency:'PEN':'symbol':'1.2-2' }}</td>
                      <td class="px-4 py-2">{{ payment.metodoPago || 'Sin método' }}</td>
                      <td class="px-4 py-2 text-xs text-slate-500">{{ payment.numeroOperacion || '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <ng-template #noPayments>
                <p class="mt-4 rounded-xl border border-dashed border-slate-200 bg-white px-4 py-3 text-sm text-slate-500">
                  No se registran pagos en esta matrícula.
                </p>
              </ng-template>
            </article>
          </div>
          <ng-template #noEnrollments>
            <p class="rounded-xl border border-dashed border-slate-200 bg-white px-4 py-3 text-sm text-slate-500">
              El alumno aún no cuenta con matrículas asociadas.
            </p>
          </ng-template>
        </div>
      </section>
    </ng-container>
  </ng-container>

  <ng-template #selectStudent>
    <div class="rounded-2xl border border-dashed border-slate-200 bg-white p-8 text-center text-sm text-slate-500">
      Selecciona un alumno desde el módulo de alumnos para visualizar su estado de cuenta.
    </div>
  </ng-template>
</section>
